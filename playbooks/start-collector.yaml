---

- hosts: all
  become: yes

  vars:
    # Note: Keeping docker packages separate just for organization
    docker_package_names: [docker-ce, docker-ce-cli, containerd.io, docker-compose-plugin, docker-buildx-plugin]
    yum_packages: [yum-utils, git, device-mapper-persistent-data, lvm2]

  tasks:
    - name: Add ec2-user to sudoers
      ansible.builtin.lineinfile:
        dest: /etc/sudoers
        line: "ec2-user ALL=(ALL) NOPASSWD: ALL"
        validate: "visudo -cf %s"

    - name: Install yum packages
      yum:
        name: "{{item}}"
        state: present
        update_cache: yes
      with_items: "{{ yum_packages }}"
    
    - name: Ensure group "docker" exists
      ansible.builtin.group:
        name: docker
        state: present

    - name: Add docker repository to yum
      command: sudo yum-config-manager --add-repo https://download.docker.com/linux/rhel/docker-ce.repo

    # https://stackoverflow.com/questions/70358656/rhel8-fedora-yum-dns-causes-cannot-download-repodata-repomd-xml-for-docker-ce
    - name: Fix the docker-ce.repo file
      command: sed -i -e 's/baseurl=https:\/\/download\.docker\.com\/linux\/\(fedora\|rhel\)\/$releasever/baseurl\=https:\/\/download.docker.com\/linux\/centos\/$releasever/g' /etc/yum.repos.d/docker-ce.repo

    - name: Install Required Docker Packages
      yum:
        name: "{{item}}"
        state: present
      with_items: "{{ docker_package_names }}"

    - name: Start Docker Service
      service:
        name: docker
        state: started
        enabled: yes

    - name: Add ec2-user to docker group
      ansible.builtin.user:
        name: ec2-user
        groups: docker
        append: yes
        state: present
    
    - name: Clone the collector repo
      ansible.builtin.git:
        repo: 'https://github.com/test-network-function/collector.git'
        dest: /home/ec2-user/collector
        clone: yes

    # TODO: The collector is now cloned and Docker is running.
    #      The next step is to run the collector container.
    #       1) Run the make commands to start the collector container
    #       2) Run the make commands to start the grafana container
